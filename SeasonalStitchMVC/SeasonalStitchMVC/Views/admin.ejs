<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard - Seasonal Stitch</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <nav class="navbar">
        <a href="/" class="brand">Seasonal Stitch</a>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/inventory">Inventory</a>
            <a href="/admin/dashboard">Dashboard</a>
            <a href="/admin/orders">Orders</a>
            <a href="/admin/reports">Reports</a>
            <a href="/admin/users">Users</a>
            <a href="/logout">Logout</a>
        </div>
    </nav>

    <div class="container">
        <h2 class="page-title">Admin Dashboard</h2>
        <div class="dashboard-grid">
            <div class="dashboard-main">
                <div class="hoodies-grid">
                    <div class="hoodie-card">
                        <div class="hoodie-info">
                            <h3>Total Users</h3>
                            <p class="price"><%= stats.users %></p>
                        </div>
                    </div>
                    <div class="hoodie-card">
                        <div class="hoodie-info">
                            <h3>Total Hoodies</h3>
                            <p class="price"><%= stats.hoodies %></p>
                        </div>
                    </div>
                    <div class="hoodie-card">
                        <div class="hoodie-info">
                            <h3>Total Orders</h3>
                            <p class="price"><%= stats.orders %></p>
                        </div>
                    </div>
                </div>

                <div class="form-container form-wide">
                    <h3>Low Stock Alerts</h3>
                    <% if (lowStockHoodies && lowStockHoodies.length > 0) { %>
                        <div class="orders-grid">
                            <% lowStockHoodies.forEach(hoodie => { %>
                                <div class="order-card">
                                    <div class="order-card-header">
                                        <div>
                                            <p class="order-label">Hoodie</p>
                                            <h3><%= hoodie.name %></h3>
                                        </div>
                                        <div class="order-meta">
                                            <span class="status-pill low-stock">Low Stock - Please resock</span>
                                        </div>
                                    </div>
                                    <div class="order-card-footer">
                                        <div>
                                            <p class="order-label">Remaining</p>
                                            <p class="order-count"><%= hoodie.stock %></p>
                                        </div>
                                        <form action="/admin/restock/<%= hoodie.hoodie_id %>" method="post" class="restock-form">
                                            <label class="order-label" for="restock-<%= hoodie.hoodie_id %>">Restock</label>
                                            <div class="restock-control">
                                                <input
                                                    id="restock-<%= hoodie.hoodie_id %>"
                                                    type="number"
                                                    name="quantity"
                                                    min="1"
                                                    placeholder="Qty"
                                                    required
                                                >
                                                <button type="submit" class="btn btn-primary btn-compact">Add</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <p class="order-muted">No low stock items right now.</p>
                    <% } %>
                </div>

                <div class="form-container form-wide">
                    <h3>Sales Analytics</h3>
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <h4>Daily Sales (Last 14 Days)</h4>
                            <% if (!dailySales || dailySales.length === 0) { %>
                                <p class="order-muted">No sales data available.</p>
                            <% } else { %>
                                <canvas id="daily-sales-chart" height="220"></canvas>
                            <% } %>
                        </div>
                        <div class="analytics-card">
                            <h4>Top Selling Hoodies</h4>
                            <% if (!topProducts || topProducts.length === 0) { %>
                                <p class="order-muted">No sales data available.</p>
                            <% } else { %>
                                <canvas id="top-products-chart" height="220"></canvas>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>

            <aside class="dashboard-side">
                <div class="form-container recent-orders-panel">
                    <h3>Recent Orders</h3>
                    <% if (recentOrders && recentOrders.length > 0) { %>
                        <div class="table-wrap">
                            <table class="recent-orders-table">
                                <thead>
                                    <tr>
                                        <th>Order ID</th>
                                        <th>User</th>
                                        <th>Total</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% recentOrders.forEach(order => { %>
                                        <% const orderDate = new Date(order.created_at); %>
                                        <tr>
                                            <td>#<%= order.order_id %></td>
                                            <td><%= order.full_name || order.email || 'Guest' %></td>
                                            <td>$<%= Number(order.total).toFixed(2) %></td>
                                            <td><%= orderDate.toLocaleDateString('en-SG', { year: 'numeric', month: 'short', day: 'numeric' }) %></td>
                                            <td>
                                                <span class="status-pill status-<%= order.status %>"><%= order.status %></span>
                                            </td>
                                        </tr>
                                    <% }) %>
                                </tbody>
                            </table>
                        </div>
                    <% } else { %>
                        <p class="order-muted">No recent orders yet.</p>
                    <% } %>
                </div>
            </aside>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const dailySalesData = <%- JSON.stringify(dailySales || []) %>;
        const topProductsData = <%- JSON.stringify(topProducts || []) %>;

        if (dailySalesData.length) {
            const dailyCtx = document.getElementById('daily-sales-chart');
            new Chart(dailyCtx, {
                type: 'line',
                data: {
                    labels: dailySalesData.map(entry => entry.label),
                    datasets: [{
                        label: 'Sales ($)',
                        data: dailySalesData.map(entry => entry.total),
                        borderColor: '#8a5d4a',
                        backgroundColor: 'rgba(210, 126, 88, 0.2)',
                        tension: 0.35,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        if (topProductsData.length) {
            const topCtx = document.getElementById('top-products-chart');
            new Chart(topCtx, {
                type: 'bar',
                data: {
                    labels: topProductsData.map(entry => entry.name),
                    datasets: [{
                        label: 'Units Sold',
                        data: topProductsData.map(entry => entry.units),
                        backgroundColor: 'rgba(95, 122, 111, 0.6)'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }
    </script>
</body>
</html>
